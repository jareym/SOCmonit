---
title: "Comparison of in situ spectrometer and UAV data"
author: "SOCmonit project team"
date: "2023-06-01"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparison of in situ spectrometer and UAV data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7.1, fig.height=7.1,
   warning=FALSE
)

```



Application of key functions for pre-processing and comparing field spectrometer data with drone data. The code is aimed at supporting novice R-users.The functions within the package help loading spectrometer and spectral response function data in the correct format, clip and mask the imagery, extract spectra at sample point locations, build spectral correction functions and correct the image. Finally a predictor response dataset can be built.
No advanced programming knowledge is needed, as necessary user input is described within the function help.

```{r libs, message=FALSE, warning=FALSE}
library(SOCmonit)

```

Here we demonstrate a simple example of the package functionalities. In order to run the entire processing chain, it is easiest to run the functions in order as written. Each function comes with a more detailed Help section which can be called using:

```{r, eval=FALSE}
?rd.UAV
#?function_name calls the function help which is available for all functions within the package
```

## Read UAV image

The first function `rd.UAV` can be populated by the user with input paths to the drone image to be read as well as an optional shapefile that is used to clip the image to the according extent e.g. the field boundaries. The function is able to either load an image taken with a MicaSense or a Tetracam camera.

```{r fig1, fig.width=7.1, fig.height=7.1, results='hide'}
#read UAV image and clip to area of interest

UAV_data_clip <- rd.UAV(path=system.file("extdata/mica.tif", package="SOCmonit"),
                        cam_type="Mica", aoipath=system.file("extdata/LTE.shp", package="SOCmonit"))
#plot the loaded image
par(mar = c(2, 2, 2, 2))
raster::plot(UAV_data_clip, main="Original Image - Plot bandwise")
```

The loaded image is then saved in the user-specified variable and can be plotted for visual inspection using the function `plot()`.

## Read ASD data

The `rd.ASD` function offers the user to either just load the data recorded with the analytical spectral device (ASD) spectroradiometer or to additionally conduct a sensor jump correction. If used with the correction step, the function has two outputs otherwise just one. The correction can be done by either using a difference or the multiplicative approach. This can be specified in the function parameters. The uncorrected and the corrected ASD data set (e.g. using the difference correction method) can be generated by using the function as: 

```{r}
asd_data <- rd.ASD(system.file("extdata/ASD",package="SOCmonit"), "2018", jumpcorr = TRUE, corrmethod = "diff")
#asd data without correction
asd_data_orig <- asd_data[[1]]
#asd data with correction
asd_data_cor <- asd_data[[2]]
```

## Plot ASD data

The effect of the ASD sensor jump correction can be visualized using the `ASDjump.plot` function. It requires the uncorrected and the corrected ASD data as inputs as well as an example sample point ID.

```{r fig2, fig.height = 3.43, fig.width = 3.43}
ASDjump.plot(asd_data_orig, asd_data_cor, "005A")
```

The resulting plots are then displayed in the `Plots` Tab within RStudio. 

## Read SRF data

The next dataset used in this process consists of the spectral response function for either the MicaSense or the Tetracam cameras. It can be loaded via the `rd.srf` function. This function expects a path to a directory as an input as well as a specification of the camera type. MicaSense spectral response functions can be loaded as:

```{r}
srf_mica <- rd.srf(system.file("extdata/SRF/Mica",package="SOCmonit"),   cam_type="Mica")

```

The dataset is saved in the specified variable and can as such be used in the further processing.

## Plot SRF data

The `UAVsrf.plot` function can be used to visualize the data saved in the variable. It needs the loaded srf as an input, a specification of the related camera as well as a wavelength range for which the data should be plotted.

```{r}
#the specified wavelengths cover the relevant range covered by the camera bands
UAVsrf.plot(srf_mica, "Mica", xmin = 350, xmax = 1000)
```

The function results in one plot that describes the sensitivity of each band in the respective wavelengths.

## Thresholds

As the following image correction function expects the user to specify thresholds for the creation of NDVI and BVIS masks, the `thresholds` function serves as a visual guide for the user to select these thresholds. It only needs the loaded drone image as an input.

```{r}
thresholds(x=UAV_data_clip)
```

The resulting plots are generated automatically and shown in the `Plots` Tab within RStudio.

## Main processing and image correction

The central function within this package is the `pp.UAVprocessing` function. It has multiple outputs that are described in the function help. These outputs are always in the same order and are left blank if the according dataset was not created e.g. the NDVI raster is not created if the vegetation correction is not chosen. Choosing all masks as well as the correction the function looks as follows:

```{r}
#mask image and conduct image correction using the specified parameters
processingoutput <- pp.UAVprocessing(x=UAV_data_clip, mask_veg = TRUE, mask_spec = TRUE, NDVI_threshold = 0.47,upper_quant = 0.98, lower_quant = 0.02, correction = TRUE, asd_data = asd_data_cor, srf = srf_mica, cam_type = "Mica", path = system.file("extdata/spoints.shp",package="SOCmonit"), corr_method = "ratio")

#the output list can now be split by the individual elements that represent the datasets
img_data_clip_cor <- processingoutput[[1]]
NDVI_mask <- processingoutput[[2]] 
BVIS_mask <- processingoutput[[3]] 
asd_cam <- processingoutput[[4]] 
cam_sample_pts <- processingoutput[[5]] 
corimg_samp_pts <- processingoutput[[6]]
```

The function output consists of [1] the corrected image, [2] the NDVI mask, [3] the BVIS mask, [4] the SRF corrected ASD data, [5] the image spectra at the sampling point locations and [6] the set of corrected image values at the sampling point locations.

It is possible to visualize the masks to see the effect that they have on the processing. This can be done using the following code:

```{r fig3, fig.height = 3.43}
#plot NDVI and BVIS masks if they were created in the imageprocessing function
par(mfrow=c(1,2), mar=c(0, 0, 1, 0))
if(!is.null(NDVI_mask)){
  raster::plot(NDVI_mask, axes=FALSE, main="NDVI Mask", legend=FALSE, col=grey(1:100/100))
}

if(!is.null(BVIS_mask)){
  raster::plot(BVIS_mask, axes=FALSE, main="BVIS Mask", legend=FALSE, col=grey(1:100/100))
}
```

You can further compare the original and the corrected image by running:

```{r}
#plot original and corrected image
raster::plot(UAV_data_clip, main="Image before correction")
raster::plot(img_data_clip_cor, main="Image after correction")
```

## Data Comparison Plots

The package also offers a specialized function for visualizing the difference and ratio between the original image values and the srf corrected ASD data that are used in the correction. The `UAVspec.pts.plot` requires inputs from the `rd.ASD` and `pp.UAVprocessing` functions as well as a specification of sample point ID, camera type and wavelengths spectrum to visualize the plots.

```{r fig4, fig.height = 3.43, fig.width = 3.43}
par(mfrow=c(1,1), mar=c(2,2,2,2))
UAVspec.pts.plot(x1=asd_data_cor, x2=cam_sample_pts, x3=asd_cam, ID.point = "003A", cam_type = "mica", xmin = 350, xmax = 2000)
```

The `UAV_UAV.ASDcor.plot` function generates a plot for the chosen sample point where original and corrected image data are compared. The ASD data is also displayed in the plot as orientation. The user has to provide inputs that are generated by the `pp.UAVprocessing` function and specify the camera type that is in use.

```{r fig5, fig.height = 5, fig.width = 5}
UAV_UAV.ASDcor.plot(x1=asd_data_cor, x2=cam_sample_pts, x3=asd_cam, x4=corimg_samp_pts, cam_type="Mica", ID.point= "005A")
```

## Predictor Response Dataset

The final function of this package `compilePR.UAV` includes functionalities for generating a predictor response dataset. The values are calculated for each sampling point within a user specified radius. The resulting table shows the band values per sample point as well as the number of observations (pixels) taken into account for the calculation of the response datasets within the given radius.

```{r}
predrespDS <- compilePR.UAV(img_data_clip_cor, cam_type = "Mica", path1 =  system.file("extdata/spoints.shp",package="SOCmonit"),buffering = TRUE, path2 = system.file("extdata/LTEbuffer.shp", package="SOCmonit"), radius= 3)

pred_resp_mean_cor <- predrespDS[[1]] 
pred_resp_median_cor <- predrespDS[[2]]

head(pred_resp_mean_cor@data)
head(pred_resp_median_cor@data)

```



The final results consist of two predictor response datasets as shown in the examples. One where the mean is calculated for the point within the radius and another where the median is used to find the response value at each point.

## Generating a Report

To generate a report summarizing the results, you can use the report.UAV function. This function creates a PDF report with descriptions and visualizations of the objects included in this example. 

**Note**: If TinyTeX is not installed on the system, this function will automatically install it to ensure proper LaTeX compilation for generating the report.

Here is an example of how to use the function:

```{r, eval = FALSE}
#Summary report
report.uav (getwd(), "report_uav", UAV_data = UAV_data_clip, asd_data = asd_data, srf_data = srf_mica, processing_output = processingoutput, predrespDS  = predrespDS, Cam_type="Mica") 

```
## Conclusion

Overall, the SOCmonit package offers a range of functionalities for preprocessing and comparing in situ spectrometer data with UAV data. The vignette demonstrates the step-by-step usage of the package's functions, providing novice R-users with a comprehensive guide. By following the examples and utilizing the functions, users can effectively process and analyze their own UAV and spectrometer data for various applications, including soil organic carbon monitoring.


For more information on the SOCmonit package and its functionalities, please refer to the package documentation and additional resources.

